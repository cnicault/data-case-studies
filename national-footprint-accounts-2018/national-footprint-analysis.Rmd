---
title: "National Footprint Accounts 2018"
author: "Christophe Nicault"
date: "28/06/2019"
output:
  html_document:
    toc: TRUE
    number_sections: TRUE

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Study

This is an analysis of the evolution of the world's biocapacity and ecological footprint. The data will be reviewed worldwide, by region, and with a deeper dive into countries with the highest rates of change.
The data for the year 2014 will then be analysed to illustrate countries with the largest ecological footprint or with the largest biocapacity, and the difference between ecological footprint and biocapacity.
Note: I will design as "contributor" countries with a higher biocapacity than footprint, and as "debtor" countries with a higher footprint than biocapacity.


# Understanding the data and missing values

```{r include=FALSE}
library(here)
library(tidyverse)
theme_update(plot.title = element_text(hjust = 0.5),
             plot.subtitle = element_text(hjust = 0.5))
```


## First contact

```{r}
path <- file.path(here::here("national-footprint-accounts-2018", "NFA 2018.csv"))
nfa <- read_csv(path)

dim(nfa)

sum(is.na(nfa))

range(nfa$year)

sapply(lapply(nfa[,names(nfa)],is.na),sum)
```


```{r}
nfa <- nfa %>%
  rename(iso_code = `ISO alpha-3 code`, gdp_2010usd = `Percapita GDP (2010 USD)`)
```


## Study the NAs

There are many NAs; we need to look into them to understand how they can impact the analysis.

There are 23490 observations with no detail (crop_land, grazing_lang, etc.) but the total is always provided.
We will be able to analyse the total footprint and biocapacity per country, but we need to be careful if we go to the detail of the type of land.

Let's understand which country have missing values, and for which period.

```{r}
nfa_na <- nfa %>% 
  filter(is.na(crop_land) | is.na(grazing_land) | is.na(forest_land) | is.na(fishing_ground) | is.na(built_up_land)) %>%
  group_by(UN_region, country) %>%
  summarize(begin = min(year),
            end = max(year))

nfa_na %>%
  ungroup() %>%
  mutate(region_country = paste(UN_region, country),
         country = fct_reorder(as.factor(country), desc(region_country))) %>%
  ggplot(aes(y = country)) +
  geom_errorbarh(aes(xmin = begin, xmax = end, color = UN_region)) +
  labs(x = "Year",
   y = "Country",
   title = "Period with missing data for the type of land",
   subtitle = "(other data are provided)")   

# Note: I can't reorder with 2 factors, so I concatenate them before, and reorder the country with this variable to order by UN_region
```

We are missing the details on a large period and for many countries, and among big countries that would have an impact (USSR).
Therefore, it won't be accurate to analyse the history for the type of land, even though we can look at the trend.


## Time range

Even if there are no missing values for other countries, the same kind of graph than above can help to visualise if these countries have data for the full period (1961 - 2014). We select only the countries who don't have data starting from 1961 or ending in 2014.

```{r}
nfa_no_data <-nfa %>% 
  filter(!is.na(crop_land) & !is.na(grazing_land) & !is.na(forest_land) & !is.na(fishing_ground) & !is.na(built_up_land)) %>%
  group_by(UN_region, country) %>%
  summarize(begin = min(year),
            end = max(year))

nfa_no_data %>%
  ungroup() %>%
  filter(begin != 1961 | end !=2014) %>%
  mutate(region_country = paste(UN_region, country),
         country = fct_reorder(as.factor(country), desc(region_country))) %>%
  ggplot(aes(y = country)) +
  geom_errorbarh(aes(xmin = begin, xmax = end, color = UN_region)) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(x = "Year",
   title = "Period covered if different than 1961-2014",
   subtitle = "for each region")   
  

```

Many countries have a long period without data at all. It is particularly true for Africa, Asia and Europe. Looking at the graph, we can guess that an analysis of the history won't be accurate, so we can visualise the trend, keeping in mind that the lack of data probably impacts the real numbers.
We can also introduce some external knowledge and information about the changing in geopolitics. In Europe, USSR has split in the 90s in Russia, Ukraine, etc. We can analyse this a bit further to understand the impact of the data that appear to be missing in the following visualisation.

* **Europe**
```{r}

no_data <- function(df, region){
  df %>%
    filter(UN_region == region) %>%
    group_by(country) %>%
    summarize(begin = min(year),
              end = max(year))  %>%
    ungroup() %>%
    mutate(country = fct_reorder(as.factor(country), desc(begin))) %>%
    ggplot(aes(y = country)) +
    geom_errorbarh(aes(xmin = begin, xmax = end)) +
    labs(x = "Year",
         y = "Country",
         title = "Period covered",
         subtitle = paste("for region : ", region))
}

nfa %>% no_data("Europe")

```

It is clear that the changes in 1991 are due to the dissolution of Yugoslavia and USSR. All the countries which start in 1991 come from the separation of these two countries. So for Europe, analysis from 1961 to 2014 would be complete, except for few years for Ireland, and a gap of a year between the end of Czechoslovakia and the data for Slovakia and the Czech Republic.

* **Africa**
```{r}

nfa %>% no_data("Africa")

```

For Africa, the data for Ethiopia PDR are split in Ethiopia and Eritrea, and the data for Sudan (former) are split between Sudan and South Sudan.
Guinea Bissau was independent in 1973, so the question is, was the information accounted with Portuguese data or were they not collected?
There are still a few countries with missing years, this can impact the accuracy for Africa, but we can still analyse the trend.

* **Asia**
```{r}

nfa %>% no_data("Asia")

```

Part of the missing data is due to countries coming from USSR, so their impact must have been accounted for USSR for the missing period.
The data for the countries in the Persian Gulf are missing until the beginning of the 80s, and the data for Saudi Arabia are completely missing except for 2014.

* **Oceania**
```{r}

nfa %>% no_data("Oceania")

```

* **North America**
```{r}

nfa %>% no_data("North America")

```

* **Latin America and the Caribbean**
```{r}

nfa %>% no_data("Latin America and the Caribbean")

```


## Last available year

To get a picture of the present situation, we will focus on the last year of data, but we need to see if some countries have an end date before 2014.

```{r}
nfa %>%
  group_by(country) %>%
  summarize(last = max(year)) %>%
  filter(last < 2014 )

```

All the countries listed are countries that have split into other countries, as the previous graph showed, except for New Zealand.
Surprisingly, the data are missing for the year 2014, the last year with data provided is 2013. We have two choices to deal with that, either we build a model to predict the values for the year 2014, or we use the number of 2013 for the year 2014, assuming that they would be close.

```{r}
nfa %>%
  filter(country == "New Zealand") %>%
  ggplot(aes(year, total)) + 
  geom_line() +
  geom_smooth() +
  facet_wrap(~record, scales = "free") +
  labs(title = "Evolution from 1961 to 2013 for New Zealand",
       subtitle = "Free scale for each graph",
       x = "Year",
       y = "Total (GHA)")
```

We can see that there is a change around 2000 with a big decrease of biocapacity since, and relative stability for the total consumption. We could build up the missing data by prolonging the decrease linearly for one more year for the biocapacity and use the mean of the last 13 years for the total consumption. But there are eight variables to build up, and the goal of the analysis is not a focus on New Zealand. Therefore I choose to report the number of the year 2013, assuming that the inaccuracy for that year for New Zealand won't change the global analysis for the world or even for Oceania.

For the analysis of the current situation, I will use the year 2014 for every country and report the number of 2013 for New Zealand.

```{r}
nfa2014 <- nfa %>%
  filter(year == 2014)

NZ <- nfa %>%
  filter(year == 2013 & country == "New Zealand") %>%
  mutate(year = 2014)

nfa2014 <- rbind(nfa2014, NZ)

```


## Check for NAs for 2014

There are 23 countries with no data for the detail in 2014.
```{r}
sapply(lapply(nfa2014[,names(nfa2014)],is.na),sum)

nfa2014 %>% 
  filter(is.na(crop_land) & is.na(grazing_land) & is.na(forest_land)) %>%
  select(country) %>% 
  distinct()

```

```{r}
nfa2014 %>% 
  filter(is.na(gdp_2010usd)) %>%
  select(country) %>% 
  distinct()
```

There are 14 countries with no information for the GDP per Capita; we can ignore them or carry out further investigations.

The data about GDP for 2014 in 2010 USD can be found at this address :
https://data.worldbank.org/indicator/NY.GDP.PCAP.KD


```{r}
path <- file.path(here::here("national-footprint-accounts-2018", "API_NY.GDP.PCAP.KD_DS2_fr_csv_v2_11733.csv"))
gdp_per_cap <- read_csv(path, skip = 4)

gdp2014 <- gdp_per_cap %>%
  select(`Country Name`, `Country Code`,`2014`)
```

Let's see if there are differences between the GDP in our data and the GDP in the world bank data. We will limit the 
request to differences above 5 %

```{r}
nfa_gdp <- nfa2014 %>%
  left_join(gdp2014, by = c("iso_code" = "Country Code")) %>%
  rename(gdp_worldbank = `2014`)

nfa_gdp %>%
  mutate(diff = (gdp_2010usd - gdp_worldbank) / gdp_2010usd * 100) %>%
  filter(diff > 5) %>%
  select(country, diff, gdp_2010usd, gdp_worldbank) %>% distinct()
```

The differences in percentage for these 3 countries are highs, but the amounts are not very high considering that this issue concern small countries, it won't impact much the analysis at a continent or world level. 

Let see which missing values we can find in these data.

```{r}
nfa_gdp %>%
  filter(is.na(gdp_2010usd) & !is.na(gdp_worldbank)) %>%
  select(country, gdp_2010usd, gdp_worldbank) %>% distinct()

replace <- which(is.na(nfa_gdp$gdp_2010usd) & !is.na(nfa_gdp$gdp_worldbank))

nfa_gdp <- nfa_gdp %>%
  mutate(gdp_2010usd = ifelse(is.na(gdp_2010usd) & !is.na(gdp_worldbank), gdp_worldbank, gdp_2010usd)) %>%
  select(-c("gdp_worldbank"))

```


```{r}
nfa_gdp %>% 
  filter(is.na(gdp_2010usd)) %>%
  select(country) %>% 
  distinct()
```

The missing values for theses countries might find an explanation in the political situation (Eritrea, North Korea), the War (Syria, Somalia).
French Polynesia, Guadeloupe, Martinique & Reunion are french territories, maybe their data are part of the French GDP. 

We will continue the analysis with these missing values.


# Evolution for the world between 1961 and 2014


## Total biocapacity &  consumption

```{r}
nfa %>%
  filter(UN_region == "World" & record %in% c("BiocapTotGHA", "EFConsTotGHA")) %>%
  select(year, record, total, population) %>%
  ggplot(aes(year, total, color = record)) +
  geom_line() +
  geom_smooth() +
  labs(x = "Year",
     y = "Total (GHA)",
     title = "Biocapacity & Consumption for the world")     

```

At the scale of the world, both the biocapacity and the consumption are growing. But we can see that :

* since 1970, the consumption is above the biocapacity
* the increase rate of the consumption is far greater than for the biocapacity

```{r}
nfa %>%
  filter(UN_region == "World" & record %in% c("BiocapTotGHA", "EFConsTotGHA") & year %in% c(1961,2014)) %>%
  select(year, record, total, population) %>%
  group_by(record) %>%
  summarize(rate = (max(total) - min(total)) / (max(year) - min(year))) %>%
  ungroup() %>%
  summarize(diff = max(rate) / min(rate))

```

Note: we could also use a linear model to get the rate which a better accuracy, which will require more steps. We are mainly interested here in the magnitude.
The total consumption is growing 5.2 faster than the biocapacity.


## Biocapacity & consumption per capita

```{r}
nfa %>%
  filter(UN_region == "World" & record %in% c("BiocapPerCap", "EFConsPerCap")) %>%
  select(year, record, total, population) %>%
  ggplot(aes(year, total, color = record)) +
  geom_line() +
  geom_smooth() +
  labs(x = "Year",
     y = "Total per Capita (GHA/person)",
     title = "Biocapacity & Consumption per capita for the world")
```

The consumption per capita has increased from 1961 to 2014, at a moderate rate, with ups and downs ( a local maximum in the 70s and a local minimum in the 90s).
The Biocapacity per capita has dramatically reduced, even though, as seen in the previous graph, the total biocapacity increased. This could be imputed to the increase of population.
The consumption per capita is above the biocapacity per capita since 1971.

```{r}
nfa %>%
  filter(UN_region == "World" & record %in% c("BiocapTotGHA", "EFConsTotGHA")) %>%
  select(year, record, total, population) %>%
  ggplot(aes(year, population)) +
  geom_line() +
  geom_smooth() +
  labs(x = "Year",
     y = "Population (persons)",
     title = "Evolution of the worldwide population")    


pop_rate <- nfa %>%
  filter(UN_region == "World" & record %in% c("BiocapTotGHA", "EFConsTotGHA") & year %in% c(1961,2014)) %>%
  select(year, record, total, population) %>%
  summarize(diff = max(population) - min(population),
            rate = diff / (max(year) - min(year)),
            prop = max(population) / min(population))

pop_rate
```

The population has been multiplied by `r pop_rate$prop` from 1960 to 2014, from 3.07 billion to 7.26 billion. Each year the population increase by `r pop_rate$rate` people.

It seems that there is a correlation between the increase of the population and the drop of the biocapacity per capita, and between the total consumption and the population. Let's find out how strong this correlation is. We can guess that it will be strong because the BiocapTotGHA and the population are both linear, and the BiocapPerCap is defined by these two variables.


```{r}
nfa_comp <- nfa %>%
  filter(UN_region == "World" & record %in% c("BiocapPerCap", "BiocapTotGHA", "EFConsPerCap", "EFConsTotGHA")) %>%
  select(year, record, total, population) %>%
  spread(key = record, value = total)


# Test the normality of the distribution
qqplot(nfa_comp$population, nfa_comp$EFConsTotGHA)
hist(nfa_comp$EFConsTotGHA)
hist(nfa_comp$population)

# The population is not normally distributed, so I will not use pearson's method, and use spearman instead.
cor.test(nfa_comp$population, nfa_comp$BiocapPerCap, method = "spearman")
cor.test(nfa_comp$population, nfa_comp$EFConsTotGHA, method = "spearman")

plot(nfa_comp$population, nfa_comp$EFConsTotGHA)

library(corrgram)

corrgram(nfa_comp,
         cor.method = "spearman",
         main = "Consumption and biocapacity",
         lower.panel=panel.shade, upper.panel=panel.pie,
         diag.panel=panel.minmax, text.panel=panel.txt)
```

Not suprising, We can confirm that the biocapacity per capita is higly negatively correlated with the population (-0.9994) and the test is higly significative p-value < 0.001.
The total consumption is higly positively correlated to the population (0.9967), and the test is higly significative p-value < 0.001.

```{r}
nfa %>%
  filter(UN_region == "World") %>%
  ggplot(aes(year, total)) + 
  geom_line() +
  geom_smooth() +
  facet_wrap(~record, scales = "free") +
  labs(title = "Evolution from 1961 to 2013 for the World",
       subtitle = "Free scale for each graph",
       x = "Year",
       y = "Total (GHA)")
```

At the world scale, the commercial exchanges balanced out, so the export and import follow the same patterns, and the consumption and production too. The purpose of the visualisation is to show the global increase in all area, production/consumption, import/export. The total biocapacity increases a bit too, but the biocapacity per capita has been divided by two during the period 1961 - 2014. (beware, all the visualisation are on a free scale)


# Evolution by region

Recalculate the values per capita at the region level.

```{r}

nfa_country_lvl <- nfa %>%
  select(c(country, iso_code, UN_region, UN_subregion, record, year, total, population, gdp_2010usd))%>%
  spread(key = record, value = total)

nfa_region_lvl <- nfa_country_lvl %>%
  group_by(UN_region, year) %>%
  summarise(BiocapPerCap = sum(BiocapPerCap*population)/sum(population),
            BiocapTotGHA = sum(BiocapTotGHA),
            EFConsPerCap = sum(EFConsPerCap*population)/sum(population),
            EFConsTotGHA = sum(EFConsTotGHA),
            EFExportsPerCap = sum(EFExportsPerCap*population)/sum(population),
            EFExportsTotGHA = sum(EFExportsTotGHA),
            EFImportsPerCap = sum(EFImportsPerCap*population)/sum(population),
            EFImportsTotGHA = sum(EFImportsTotGHA),
            EFProdPerCap = sum(EFProdPerCap*population)/sum(population),
            EFProdTotGHA = sum(EFProdTotGHA),
            population = sum(population))

```


## Biocapacity per capita

```{r}
nfa_region_lvl %>%
  filter(UN_region != "World") %>%
  ggplot(aes(year, BiocapPerCap, color = UN_region))+
  geom_line()+
  labs(x = "Year",
       y = "Biocapacity per Capita (GHA/person)",
       title = "Biocapacity per capita for each region")

```


The biocapacity per capita decreases in every region of the world. The rate seems particularly high in Oceania and Latin America & Caribbean.

```{r}
nfa_country_lvl %>%
  filter(UN_region == "Oceania") %>%
  ggplot(aes(year, BiocapPerCap, color = country))+
  geom_line()+
  labs(x = "Year",
       y = "Biocapacity per Capita (GHA/person)",
       title = "Biocapacity per capita for Oceania")

```

Focusing on Oceania, we can see that most of the biocapacity (and the decrease of it) is due to 3 countries, Australie, New Zealand, and at a lower level Papua New Guinea. Australia is a huge country with a low density of population, so it's high biocapacity per capita in the region is not surprising.

```{r}

nfa_country_lvl %>%
  filter(UN_region == "Latin America and the Caribbean") %>%
  ggplot(aes(year, BiocapPerCap, color = country))+
  geom_line()+
  labs(x = "Year",
       y = "Biocapacity per Capita (GHA/person)",
       title = "Biocapacity per capita for each region")

```

In Latin America, the higher biocapacity and the biggest decrease is due to French Guyana. 

The visualisation per region shows that within a region there are big variations, there is a big range of values with some country having a big amount, balanced by many countries with a small amount. Oceania is the region with the highest biocapacity per capita, but looking in detail, some country in other region have far more biocapacity per capita, but the overall amount is reduced due to the number of countries in that region with a very low value.

For example, in Latin America; French Guiana and Brazil have far more biocapacity per capita than the top countries in Oceania, but in Latin America, there are many countries with a low biocapacity per capita, which lower the numbers for the region.

As a result, it's more interesting to look at the top countries for biocapacity and consumption, rather than by regions which are composed of disparate countries.

We can, however, make a visualisation to see at regional level the evolution between biocapacity and consumption, and which region have higher consumption, and the trend over time

```{r}
nfa_region_lvl %>%
  filter(UN_region != "World") %>%
  ggplot(aes(year, EFConsTotGHA, ymin = BiocapTotGHA, ymax = EFConsTotGHA, fill = UN_region))+
  geom_line()+
  geom_ribbon(alpha = 0.5) +
  facet_wrap(~UN_region, scales = "fixed") +
  labs(x = "Year",
       y = "Biocapacity (GHA)",
       title = "Gap between Consumption and Biocapacity for each region",
       subtitle = "The black line represents the consumption")

```

We can see that Asia, Europe and North America have a consumption above biocapacity during all the period shown. Africa's consumption has just recently exceeded its biocapacity. The other regions still have a biocapacity above consumption. Even if the biocapacity increases in Asia, the rate at which the consumption grows and the growth of the gap between biocapacity and consumption are impressive compared to the other regions.


# Highest contributors


## Highest decrease rate in biocapacity per capita

Let's have a look at the countries at the top and bottom of the biocapacity rate.

```{r}
bio_rate <- nfa_country_lvl %>%
  group_by(country) %>%
  summarise(diff_year = diff(range(year)),
            diff_bio = diff(range(BiocapPerCap)),
            rate = diff_bio / diff_year) %>%
  arrange(desc(rate)) %>%
  head(15)

nfa_bio <- nfa_country_lvl %>%
  inner_join(bio_rate, by = c("country" = "country"))

nfa_bio %>%
  arrange(desc(rate)) %>%
  ggplot(aes(year, BiocapPerCap, color = country))+
  geom_line()+
  labs(x = "Year",
       y = "Biocapacity per Capita (GHA/person)",
       title = "Biocapacity per capita for the highest decreasing rate",
       subtitle = "15 first countries with highest decreasing rate")  
  
```

The highest lost in biocapacity per capita is French Guiana. Is it due to a decrease in the total biocapacity, the increase in the population or both?

```{r}
prop <- nfa_country_lvl %>%
  filter(country == "French Guiana") %>%
  filter(year %in% c(min(year), max(year))) %>%
  select(BiocapPerCap, BiocapTotGHA, population)

prop[2,] / prop[1,]

```

The division by 2 of the biocapacity of French Guyana is mainly due to the increase of the population which has almost been multiply by 2. During that time, the total biocapacity has slightly decreased (3%).


## Highest bio capacity / consumption and debt per capita

```{r}
nfa2014 %>%
  filter(record == "BiocapPerCap", country != "World") %>%
  arrange(desc(total)) %>%
  head(20) %>%
  mutate(country = fct_reorder(country, total)) %>%
  ggplot(aes(country, total, fill = total)) +
  geom_col() +
  scale_fill_gradient(low = "green4", high = "chartreuse") +
  coord_flip() +
  labs(x = "Country",
       y = "Biocapacity per Capita (GHA/person)",
       title = "20 first countries whith highest Biocapacity per capita")

```


```{r}
  
nfa2014 %>%
  filter(record == "EFConsPerCap", country != "World") %>%
  arrange(desc(total)) %>%
  head(20) %>%
  mutate(country = fct_reorder(country, total)) %>% arrange(desc(population)) %>%
  ggplot(aes(country, total, fill = gdp_2010usd)) +
  scale_fill_gradient(low = "pink", high = "red") +
  geom_col() +
  coord_flip()+
  labs(x = "Country",
       y = "Consumption per Capita (GHA/person)",
       title = "20 first countries whith highest Consumption per capita")
```

The first countries with the highest consumption per capita are wealthy countries with low population compared to their life level (Qatar, Luxembourg). We find the countries from the Middle East producing oil (Qatar, Emirates, Bahrain, Kuwait, Oman, Saudi Arabia). Countries with high consumption (China, India) but with a high population don't have a high consumption per capita, where countries with a lower number of inhabitants (USA, Canada) are in the firsts place for consumption per capita.

```{r}

nfa2014 %>%
  select(country, year, record, population, total) %>%
  filter(record %in% c("BiocapPerCap", "EFConsPerCap"), country != "World") %>%
  spread(key = record, value = total) %>%
  mutate(debt =  EFConsPerCap - BiocapPerCap) %>%
  arrange(desc(debt)) %>% 
  head(20) %>%
  mutate(country = fct_reorder(country, debt)) %>%
  ggplot(aes(country, debt, fill = debt)) +
  geom_col() +
  scale_fill_gradient(low = "pink", high = "red") +  
  coord_flip() +
  labs(x = "Countries",
       y = "Debt per Capita (GHA/person)",
       title = "20 first countries with the highest ecological debt per capita (GHA/person)",
       subtitle = "Debt = Consumption - biocapactiy")
```

The countries with the highest ecological debt (consumption - biocapacity) are the wealthy countries with a small or arid territory. The first countries are still the oil producer from the Middle East, Luxembourg, which has a small territory and therefore poor biocapacity.

```{r}

library(plotly)

plt1 <- nfa2014 %>%
  select(country, UN_region, year, record, population, total, gdp_2010usd) %>%
  filter(record %in% c("EFConsPerCap"), country != "World") %>%
  ggplot(aes(gdp_2010usd, total, size = population, color= UN_region, label = country)) +
  geom_point() +
  scale_y_log10()+
  scale_x_log10() +
  labs(x = "gdp per capita log(USD 2010)",
     y = "Consumption per Capita log(GHA/person)",
     title = "Consumption per capita vs GDP per capita",
     subtitle = "log scale")

ggplotly(plt1)

cons_vs_gdp <-nfa2014 %>%
select(country, record, total, gdp_2010usd) %>%
filter(record %in% c("EFConsPerCap"), country != "World") 
 
cor.test(log(cons_vs_gdp$gdp_2010usd), log(cons_vs_gdp$total))

```

On a log scale, there's a strong correlation between the consumption per cap and the gdp per cap. We can see that the countries in Asia spread along the graph, with Timor at the lowest consumption and Qatar with the highest. Europe and North America are at the top half of the graph, where Africa is at the bottom half. Latin America and the Caribbean are located in the middle. Anyway, the regions overlap, and therefore, Countries from different regions can be close, the top of African countries are close to the bottom of European countries and the middle of Latin American countries (Romania, Gabon, Mexico for example)


## Highest total bio capacity / consumption

```{r}
require(maps)

tbl_df(iso3166)
iso3166$mapname <- str_replace(iso3166$mapname, pattern = "\\(.*\\)", "")

nfa2014 %>%
  filter(record == "BiocapTotGHA", country != "World") %>%
  arrange(desc(total)) %>%
  head(15) %>%
  mutate(country = fct_reorder(country, total)) %>%
  ggplot(aes(country, total, fill = total)) +
  geom_col() +
  scale_fill_gradient(low = "green4", high = "chartreuse") +  
  coord_flip() +
  labs(x = "Countries",
     y = "Total Biocapacity (GHA)",
     title = "15 first countries with highest Biocapacity")


```

The first countries for biocapacity are the countries with a wide territory and resources, Brazil, China, USA, Russia, India, Canada

```{r}

worldmap <- map_data("world") %>% tbl_df %>% filter(region !="Antarctica")

mapdata <- nfa2014 %>% 
  filter(record == "BiocapTotGHA") %>%
  select(country, iso_code, record, total, population) %>%
  inner_join(iso3166, by = c("iso_code" = "a3")) %>%
  right_join(worldmap, by = c("mapname" = "region"))


mapdata %>%
ggplot(aes(long, lat, group = group, fill = total)) +
  geom_polygon(color = "white") +
  scale_fill_gradient(low = "green4", high = "chartreuse") +
  coord_fixed(1.5) +
  ggthemes::theme_map()+
  labs(title = "Total biocapacity in 2014",
       fill = "Biocapacity (GHA)")

```

The total biocapacity compared to the surface of the territory is shown on the map.

```{r}
nfa2014 %>%
  filter(record == "EFConsTotGHA", country != "World") %>%
  arrange(desc(total)) %>%
  head(15) %>%
  mutate(country = fct_reorder(country, total)) %>%
  ggplot(aes(country, total, fill = total)) +
  geom_col() +
  scale_fill_gradient(low = "pink", high = "red") +  
  coord_flip() +
  labs(x = "Countries",
       y = "Total consumption (GHA)",
       title = "15 first countries with the highest consumption")  

```

The top list for consumption is not surprising, China and India, mainly due to the large population and the improvement of the lifestyle. USA, Russia and Brazil complete the top 5. We can find the top countries for economic activities, such as Japan, Germany, France, UK.

```{r}
mapdata <- nfa2014 %>% 
  filter(record == "EFConsTotGHA") %>%
  select(country, iso_code, record, total, population) %>%
  inner_join(iso3166, by = c("iso_code" = "a3")) %>%
  right_join(worldmap, by = c("mapname" = "region"))

mapdata %>%
ggplot(aes(long, lat, group = group, fill = total)) +
  geom_polygon(color = "white") +
  scale_fill_gradient2(low="blue", mid = "pink", high = "red") +
  coord_fixed(1.5) +
  ggthemes::theme_map() +
  labs(title = "Total consumption in 2014",
       fill = "Consumption (GHA)")

```

The map looks similar to the previous one, with the same top countries for consumption than for biocapacity.


## Carbon Emission


### Evolution over time

```{r}
nfa %>%
  filter(UN_region == "World" & record %in% c("EFConsTotGHA")) %>%
  select(year, record, total, carbon, population) %>%
  ggplot(aes(year, carbon, color = record)) +
  geom_line() +
  geom_smooth() +
  labs(x = "Year",
     y = "Carbon emission (GHA)",
     title = "Evolution of the carbon emission for the world")     

nfa %>%
  filter(UN_region == "World" & record %in% c("EFConsPerCap")) %>%
  select(year, record, total, carbon, population) %>%
  ggplot(aes(year, carbon, color = record)) +
  geom_line() +
  geom_smooth() +
  labs(x = "Year",
     y = "Carbon emission per capita (GHA)",
     title = "Evolution of the carbon emission per capita for the world")     

```

The shape of the 2 graphs are very similar to the EF consumption, per capita and in total.
Let's find the correlation between carbon emission and consumption.


```{r}

nfa_corcarb <- nfa %>%
  filter(UN_region == "World" & record %in% c("EFConsTotGHA")) %>%
  select(year, record, total, population, carbon) %>%
  spread(key = record, value = total)


qqplot(nfa_corcarb$carbon, nfa_corcarb$EFConsTotGHA)
hist(nfa_corcarb$EFConsTotGHA)
hist(nfa_corcarb$carbon)

# The carbon emission is not normally distributed, so I will not use pearson's method, and use spearman instead.
cor.test(nfa_corcarb$carbon, nfa_corcarb$EFConsTotGHA, method = "spearman")

plot(nfa_corcarb$carbon, nfa_corcarb$EFConsTotGHA)

library(corrgram)

corrgram(nfa_corcarb,
         cor.method = "spearman",
         main = "Carbon and Consumption",
         lower.panel=panel.shade, upper.panel=panel.pie,
         diag.panel=panel.minmax, text.panel=panel.txt)

```

There is a strong positive correlation between carbon emission and consumption.
Let's find out at what rate they are growing.

```{r}
nfa_corcarb %>%
  filter(year == min(year) | year == max(year)) %>%
  summarise(rate_pop = max(population) / min(population),
            rate_carb = max(carbon) / min(carbon),
            rate_EF = max(EFConsTotGHA) / min(EFConsTotGHA))

```

Between 1961 and 2014, the population has been multiply by 2.36, the consumption by 2.93, and the carbon emission by 4.01.

We can visualize the similarity of the evolution on the following graph:

```{r}

nfa_corcarb %>%
  gather(type, value, -year) %>%
  ggplot(aes(year, value)) +
  geom_line()+
  facet_wrap(~type, scale ="free") +
  labs(title = "Comparison of the evolution between carbon emissions, consumption and population",
       subtitle = "Free scale for each graph",
       x = "Year",
       y = "Total (GHA)")
```


### Situation in 2014

```{r}
carbon <- nfa2014 %>%
  select(country, iso_code, year, record, population, total, carbon, gdp_2010usd) %>%
  filter(record %in% c("EFConsTotGHA"), country != "World") %>%
  mutate(carbon_percap = carbon / population)

carbon %>%
  arrange(desc(carbon)) %>%
  head(15) %>%
  mutate(country = fct_reorder(country, carbon)) %>%
  ggplot(aes(country, carbon, fill = carbon)) + 
    geom_col() + 
    coord_flip() +
    scale_fill_gradient(low = "pink", high = "red") +
    labs(x = "Carbon emission (GHA)",
         title = "15 first countries with the highest carbon emission") 
```

The first higher emitters of CO2 are the same countries that are the first in consumption. Some countries changed position (Brazil, Iran).

```{r}
mapdata <- carbon %>% 
  select(country, iso_code, carbon, carbon_percap) %>%
  inner_join(iso3166, by = c("iso_code" = "a3")) %>%
  right_join(worldmap, by = c("mapname" = "region"))


mapdata %>%
ggplot(aes(long, lat, group = group, fill = carbon)) +
  geom_polygon(color = "white") +
  scale_fill_gradient(low="pink", high = "red") +
  coord_fixed(1.5) +
  ggthemes::theme_map() +
  labs(title = "Carbon emission in 2014 in GHA",
       fill = "Carbon emission (GHA)")

```

The map for the carbon emission is very similar to the one for consumption.
Of course, countries like China and India have a high level of global emission, but as they have a huge population, let's have a look at the main emitters per capita.

```{r}
carbon %>%
  arrange(desc(carbon_percap)) %>%
  head(15) %>%
  mutate(country = fct_reorder(country, carbon_percap)) %>%
  ggplot(aes(country, carbon_percap, fill = carbon_percap)) + 
    geom_col() + 
    coord_flip() +
    scale_fill_gradient(low = "pink", high = "red") +
    labs(x = "Carbon emission per capita (GHA)",
         title = "15 first countries with the highest carbon emission per capita")   


mapdata %>%
ggplot(aes(long, lat, group = group, fill = carbon_percap)) +
  geom_polygon(color = "white") +
  scale_fill_gradient(low="pink", high = "red") +
  coord_fixed(1.5) +
  ggthemes::theme_map() +
  labs(title = "Carbon emission per capita in 2014 in GHA",
       fill = "Carbon emission (GHA/person)")

```

When looking at carbon emissions per person, the configuration of the map changes and seems more measured. That said, the global impact on the planet is measured by the total emissions seen in the previous map.


## Highest debt and contribution

```{r}
nfa2014 %>%
  select(country, year, record, population, total, gdp_2010usd) %>%
  filter(record %in% c("BiocapTotGHA", "EFConsTotGHA", "EFConsPerCap"), country != "World") %>%
  spread(key = record, value = total) %>%
  mutate(contrib =  BiocapTotGHA - EFConsTotGHA) %>%
  arrange(desc(contrib)) %>% 
  head(20) %>%
  mutate(country = fct_reorder(country, contrib)) %>%
  ggplot(aes(country, contrib, fill = BiocapTotGHA)) +
  geom_col() +
  coord_flip() +
  scale_fill_gradient(low = "green4", high = "chartreuse") +
  labs(x = "Total Biocapacity excedent (GHA)",
       title = "20 first countries with the highest contribution",
       subtitle = "contribution = biocapacity - Consumption")    

```

I define the contribution as the difference between the biocapacity and the consumption, to see which countries have still a positive impact. Brazil is far ahead, and we can find Canada, Russia, Australia, which even if they are in the top countries for consumption have still a positive impact due to their high biocapacity. Main countries are from Latin America and Africa, which can make sense due to their natural environment and low consumption.

```{r}
nfa2014 %>%
  select(country, year, record, population, total, gdp_2010usd) %>%
  filter(record %in% c("BiocapTotGHA", "EFConsTotGHA", "EFConsPerCap"), country != "World") %>%
  spread(key = record, value = total) %>%
  mutate(debt =  EFConsTotGHA - BiocapTotGHA) %>%
  arrange(desc(debt)) %>% 
  head(20) %>%
  mutate(country = fct_reorder(country, debt)) %>%
  ggplot(aes(country, debt, fill = EFConsTotGHA)) +
  geom_col() +
  coord_flip() +
  scale_fill_gradient(low = "pink", high = "red") +
  labs(x = "Total Biocapacity excedent (GHA)",
       title = "20 first countries with the highest debt",
       subtitle = "debt = Consumption - biocapacity") 
  

```

I define the debt as the difference between the consumption and the biocapacity, to see which countries have still a negative impact. The top 3 countries are China, the USA and India. We can find as well the European countries with the most active economy (Germany, UK, Italy)


```{r}

eco_impact <- nfa2014 %>%
  select(country, iso_code, year, record, population, total, gdp_2010usd) %>%
  filter(record %in% c("BiocapTotGHA", "EFConsTotGHA"), country != "World") %>%
  spread(key = record, value = total) %>%
  mutate(impact =  ifelse((BiocapTotGHA - EFConsTotGHA) < 0, (BiocapTotGHA - EFConsTotGHA) / EFConsTotGHA * 100, (BiocapTotGHA - EFConsTotGHA) / BiocapTotGHA * 100))


mapdata <- eco_impact %>% 
  select(country, iso_code, impact, population) %>%
  inner_join(iso3166, by = c("iso_code" = "a3")) %>%
  right_join(worldmap, by = c("mapname" = "region"))


mapdata %>%
ggplot(aes(long, lat, group = group, fill = impact)) +
  geom_polygon(color = "white") +
  scale_fill_gradient2(low="red", mid = "grey", high = "chartreuse", midpoint = 0) +
  coord_fixed(1.7) +
  ggthemes::theme_map() +
  labs(title = "Ecological debt or contribution in 2014",
       subtitle = "debt in % of consumption and contribution in % of biocapacity",
       fill = "Impact (%)")

```


The map displays the contribution for each country as a percentage of their biocapacity and the debt as a percentage of their consumption.
The main countries (China, USA) seem to balance better in percentage compared to others like Iran.
But what is interested at a world level is the global impact on the planet. Let's see the impact in total with the next map.

```{r}

eco_impact <- nfa2014 %>%
  select(country, iso_code, year, record, population, total, gdp_2010usd) %>%
  filter(record %in% c("BiocapTotGHA", "EFConsTotGHA"), country != "World") %>%
  spread(key = record, value = total) %>%
  mutate(impact =  ifelse((BiocapTotGHA - EFConsTotGHA) < 0, BiocapTotGHA - EFConsTotGHA, BiocapTotGHA - EFConsTotGHA))


mapdata <- eco_impact %>% 
  select(country, iso_code, impact, population) %>%
  inner_join(iso3166, by = c("iso_code" = "a3")) %>%
  right_join(worldmap, by = c("mapname" = "region"))


mapdata %>%
ggplot(aes(long, lat, group = group, fill = impact)) +
  geom_polygon(color = "white") +
  scale_fill_gradient2(low="red", mid = "grey", high = "chartreuse", midpoint = 0) +
  coord_fixed(1.7) +
  ggthemes::theme_map() +
  labs(title = "Ecological debt or countribution in 2014",
       subtitle = "in GHA",
       fill = "Impact (GHA)")

```

Looking at the map with the total contribution or debt, we can see that China, USA and India stand out. The countries with a positive impact (Brazil, Canada, Russia), can't counterbalance the level of the countries with the highest negative impact.


# Countries who consumes half of the total consumption

Looking at the previous map, it seems that only a few countries have a huge impact on the total consumption on the planet.

```{r}

eco_debt_tot <- nfa2014 %>%
  select(country, iso_code, year, record, population, total, gdp_2010usd) %>%
  filter(country != "World") %>%
  spread(key = record, value = total) %>%
  mutate(debt =  ifelse((BiocapTotGHA - EFConsTotGHA) < 0, (BiocapTotGHA - EFConsTotGHA), (BiocapTotGHA - EFConsTotGHA)))

eco_debt_tot %>%
  arrange(debt)%>%
  head(5) %>%
  summarise(tot = sum(EFConsTotGHA) / sum(eco_debt_tot$EFConsTotGHA))

eco_debt_tot %>%
  group_by(EFConsTotGHA) %>%
  arrange(desc(EFConsTotGHA)) %>%
  summarise(country = country,
            ratio = sum(EFConsTotGHA) / sum(eco_debt_tot$EFConsTotGHA)) %>%
  ungroup() %>%
  arrange(desc(ratio)) %>%
  mutate(cr = cumsum(ratio)) %>%
  filter(cr < 0.66) %>% 
  mutate(country = fct_reorder(country, ratio)) %>%
  ggplot(aes(country, ratio, fill = EFConsTotGHA)) + 
  scale_fill_gradient(low="pink", high = "red") +  
  geom_col() +
  coord_flip() + 
  labs(title = "Consumption of the first countries that consume 2/3 of the world consumption",
       subtitle = "ration is the percentage of total consumption")

```

Only 12 countries consume 2/3 of the total world consumption.
China, USA, India, Russia and Brazil consumes more than half of the total world consumption.
We can show it as a map of the first country with the higher consumption that consumes 2/3 of the total world consumption :

```{r}

eco_map <- eco_debt_tot %>%
  group_by(EFConsTotGHA) %>%
  arrange(desc(EFConsTotGHA)) %>%
  summarise(iso_code,
            country = country,
            ratio = sum(EFConsTotGHA) / sum(eco_debt_tot$EFConsTotGHA)) %>%
  ungroup() %>%
  arrange(desc(ratio)) %>%
  mutate(cr = cumsum(ratio)) %>%
  filter(cr <= 0.66) 

mapdata <- eco_map %>% 
  select(country, iso_code, ratio) %>%
  inner_join(iso3166, by = c("iso_code" = "a3")) %>%
  right_join(worldmap, by = c("mapname" = "region"))


mapdata %>%
ggplot(aes(long, lat, group = group, fill = ratio)) +
  geom_polygon(color = "white") +
  scale_fill_gradient(low="pink", high = "red") +
  coord_fixed(1.7) +
  ggthemes::theme_map() +
  labs(title = "Countries which consumes 2/3 of the ressources of the planet.",
       subtitle = "First main contributors",
       fill = "% of total consumption")

```

What is the trend over time for the first five countries ?

```{r}
first_five <- nfa_country_lvl %>%
  filter(year == 2014, country != "World") %>%
  arrange(desc(EFConsTotGHA)) %>%
  head(5) %>%
  select(country) %>%
  pull()


nfa_country_lvl %>%
  filter(country %in% first_five) %>%
  ggplot(aes(year, EFConsTotGHA, ymin = BiocapTotGHA, ymax = EFConsTotGHA, fill = country))+
  geom_line()+
  geom_ribbon(alpha = 0.5) +
  facet_wrap(~country, scales = "fixed") +
  labs(x = "Year",
       y = "Biocapacity / Consumption (GHA)",
       title = "Difference between Biocapacity and EFConsTotGHA for the first 5 biggest consumers",
       subtitle = "The black line represent the consumption")
```

We can see that for the countries with higher consumption than biocapacity (China, India, USA), the gap is clearly increasing, the consumption rate is higher than the biocapacity rate. For the countries with a higher biocapacity than consumption, the gap is reducing, even if their biocapacity increases too. 


# Type of land

```{r}
nfa %>%
  filter(record %in% c("BiocapTotGHA", "EFConsTotGHA"), UN_region == "World", !is.na(crop_land), 
         !is.na(grazing_land), !is.na(forest_land), !is.na(fishing_ground), !is.na(built_up_land)) %>%
  select(year, record, total, crop_land, grazing_land, forest_land, fishing_ground, built_up_land, carbon) %>%
  group_by(year, record) %>% 
  summarise(crop = sum(crop_land, na.rm = TRUE),
            grazing = sum(grazing_land, na.rm = TRUE),
            forest = sum(forest_land, na.rm = TRUE),
            fishing = sum(fishing_ground, na.rm = TRUE),
            build_p = sum(built_up_land, na.rm = TRUE),
            carbon = sum(carbon, na.rm = TRUE),
            total = sum(total)) %>% 
  gather(type, value, -c("year","record","total")) %>%
  group_by(year, type, record) %>%
  ggplot(aes(year, value, color = record)) +
    geom_line(position=position_jitter(w=0.1, h=0.5)) +
  facet_wrap(~type, scale = "free") +
  scale_color_manual(values = c("green4", "red")) +
  labs(x = "year",
       y = "total in GHA",
       title = "Evolution by type of land for biocapacity and consumption over years")


```

The biocapacity is over the consumption for fishing land, forest, and grazing. Biocapactiy and consumption are the same for crop land which makes sense because all biocapacity is used for consumption. It's the same for build-up land, all the capacity of the area is used for production. So the fact that in total, the consumption is above the biocapacity is entirely due to carbon emissions. The biocapacity for carbon is contained in forest land, which takes into consideration timber product as well as sequestration.


# Conclusion

The analysis of the data shows that :

* The consumption is higher than the biocapacity since the '70s.
* The increase rate of consumption is higher than the biocapacity increase rate, so the gap between the two is increasing.
* The carbon emissions follow the consumption, and at a higher rate
* Only five countries consume 50% of the total consumption
* 2/3 of the total consumption is due to the first 12 countries.
* There are changes in the top countries based on an analysis of the total or per capita, due to the effect of the population size.



